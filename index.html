<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®¶åº­è®°è´¦æœ¬</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* å…¨å±€æ ·å¼ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "PingFang SC", "Microsoft YaHei", sans-serif;
            color: #333;
        }
        body {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f7f7f7;
            min-height: 100vh;
        }
        .container {
            background: #fff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
        }
        h1 {
            text-align: center;
            color: #d23c32;
            margin-bottom: 30px;
            font-weight: 600;
        }

        /* è®¾ç½®æŒ‰é’® */
        .settings-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #d23c32;
            color: #fff !important;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 100;
        }

        /* è®¾ç½®é¢æ¿ */
        .settings-panel {
            position: fixed;
            top: 0;
            right: 0;
            width: 350px;
            max-width: 100%;
            height: 100vh;
            background: #fff;
            box-shadow: -8px 0 24px rgba(0,0,0,0.1);
            z-index: 999;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            padding: 40px 20px 20px;
            overflow-y: auto;
        }
        .settings-panel.show { transform: translateX(0); }
        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        .settings-title {
            font-size: 18px;
            font-weight: 600;
            color: #d23c32;
        }
        .close-settings {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #f5f5f5;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        .settings-group { margin-bottom: 25px; }
        .settings-group-title {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #555;
        }
        .custom-item {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
            padding: 8px 10px;
            background: #f5f5f5;
            border-radius: 6px;
        }
        .custom-item input {
            flex: 1;
            padding: 6px 8px;
            border: 1px solid #eee;
            border-radius: 4px;
            font-size: 14px;
        }
        .custom-btn {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            border: none;
            background: #d23c32;
            color: #fff !important;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .add-btn {
            background: #2e7d32;
            color: #fff !important;
            width: 100%;
            padding: 8px 0;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            margin-top: 10px;
            font-size: 14px;
        }
        .save-settings {
            background: #d23c32;
            color: #fff !important;
            width: 100%;
            padding: 12px 0;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            margin-top: 20px;
            font-size: 15px;
        }

        /* å½•å…¥åŒºåŸŸ */
        .input-section {
            border-bottom: 1px solid #eee;
            padding-bottom: 25px;
            margin-bottom: 25px;
        }
        .form-group {
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        .form-group label {
            width: 80px;
            font-weight: 500;
            flex-shrink: 0;
        }
        .form-group select, 
        .form-group input, 
        .form-group textarea {
            flex: 1;
            min-width: 200px;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        .form-group select:focus, 
        .form-group input:focus, 
        .form-group textarea:focus {
            outline: none;
            border-color: #d23c32;
        }
        .form-group button {
            background: #d23c32;
            color: #fff !important;
            border: none;
            padding: 10px 30px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 500;
        }
        .form-group .edit-btn { background: #2e7d32; }
        .remark-tags {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        .remark-tag {
            padding: 5px 12px;
            background: #f5f5f5;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
        }

        /* ========== æ ¸å¿ƒï¼šå¹´/æœˆ/æ—¥ç­›é€‰åŒºåŸŸ ========== */
        .filter-section {
            margin-bottom: 25px;
            padding: 20px;
            background: #fafafa;
            border-radius: 8px;
            border: 1px solid #eee;
        }
        /* ç»´åº¦åˆ‡æ¢æŒ‰é’®ç»„ */
        .dimension-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        .dimension-tab {
            padding: 8px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 500;
            transition: all 0.2s ease;
            background: #fff;
            border: 1px solid #ddd;
        }
        .dimension-tab.active {
            background: #d23c32;
            color: #fff !important;
            border-color: #d23c32;
        }
        /* ç­›é€‰å†…å®¹åŒº */
        .filter-content {
            margin-bottom: 15px;
        }
        /* ç»´åº¦é€‰é¡¹åˆ—è¡¨ */
        .dimension-options {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            max-height: 180px;
            overflow-y: auto;
            padding: 10px;
            background: #fff;
            border-radius: 6px;
            border: 1px solid #eee;
        }
        .dimension-option {
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            border: 1px solid #ddd;
            transition: all 0.2s ease;
            white-space: nowrap;
        }
        .dimension-option:hover {
            border-color: #d23c32;
            color: #d23c32;
        }
        .dimension-option.active {
            background: #d23c32;
            color: #fff !important;
            border-color: #d23c32;
        }
        /* ç­›é€‰åº•éƒ¨æ“ä½œæ  */
        .filter-bottom {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            align-items: center;
            justify-content: space-between;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }
        .user-filter {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }
        .user-filter label { font-weight: 500; }
        .user-checkbox-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .user-checkbox-item {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 14px;
        }
        .user-checkbox-item input {
            width: 16px;
            height: 16px;
            accent-color: #d23c32;
        }
        .data-op-btn {
            display: flex;
            gap: 10px;
        }
        .data-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            color: #fff !important;
        }
        .export-btn { background: #2e7d32; }
        .import-btn { background: #0277bd; }
        #importFile { display: none; }

        /* ç»Ÿè®¡åŒºåŸŸ */
        .stats-section {
            margin-bottom: 25px;
        }
        .stats-title {
            font-weight: 600;
            color: #d23c32;
            margin-bottom: 15px;
            font-size: 18px;
        }
        .stats-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .stats-item {
            padding: 15px;
            background: #fafafa;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #eee;
        }
        .stats-item .label {
            font-size: 13px;
            color: #888;
            margin-bottom: 8px;
        }
        .stats-item .value {
            font-size: 20px;
            font-weight: 600;
        }
        .expense { color: #d23c32; }
        .income { color: #2e7d32; }
        .balance { color: #f57c00; }
        /* å›¾è¡¨åŒºåŸŸ */
        .chart-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .chart-item {
            padding: 15px;
            background: #fafafa;
            border-radius: 8px;
            border: 1px solid #eee;
        }
        .chart-title {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 10px;
            text-align: center;
        }
        .chart-container {
            width: 100%;
            height: 280px;
        }
        /* åˆ†ç±»æ˜ç»† */
        .category-stats {
            margin-top: 20px;
        }
        .category-title {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 10px;
        }
        .category-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
        }
        .category-item {
            padding: 10px;
            background: #fafafa;
            border-radius: 6px;
            font-size: 14px;
            border: 1px solid #eee;
        }
        .category-item .name {
            color: #888;
            font-size: 12px;
            margin-bottom: 5px;
        }

        /* è´¦å•æ˜ç»†åŒºåŸŸ */
        .records-section {
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #eee;
        }
        .batch-operate {
            padding: 10px 15px;
            background: #fafafa;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .batch-select {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .batch-select input {
            width: 18px;
            height: 18px;
            accent-color: #d23c32;
        }
        .batch-delete-btn {
            background: #d23c32;
            color: #fff !important;
            border: none;
            padding: 6px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
        }
        .batch-delete-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .records-section table {
            width: 100%;
            border-collapse: collapse;
        }
        .records-section th, .records-section td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        .records-section th {
            background: #fafafa;
            font-weight: 500;
            font-size: 14px;
            position: sticky;
            top: 0;
        }
        .checkbox-col {
            width: 40px;
            text-align: center !important;
        }
        .amount-col {
            text-align: right !important;
        }
        .operate-btn {
            display: flex;
            gap: 10px;
        }
        .edit-btn {
            color: #2e7d32;
            cursor: pointer;
            font-size: 13px;
        }
        .delete-btn {
            color: #d23c32;
            cursor: pointer;
            font-size: 13px;
        }
        .empty-state {
            padding: 40px 20px;
            text-align: center;
            color: #888;
        }

        /* å¼¹çª—æ ·å¼ */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        .modal-box {
            background: #fff;
            border-radius: 12px;
            padding: 30px;
            width: 90%;
            max-width: 400px;
            transform: translateY(20px);
            transition: transform 0.3s ease;
        }
        .modal-overlay.show .modal-box { transform: translateY(0); }
        .modal-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            text-align: center;
        }
        .modal-content {
            font-size: 14px;
            color: #666;
            margin-bottom: 25px;
            text-align: center;
            line-height: 1.6;
        }
        .modal-btns {
            display: flex;
            gap: 15px;
            justify-content: center;
        }
        .modal-btn {
            padding: 10px 25px;
            border-radius: 6px;
            border: none;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
        }
        .modal-btn.cancel { background: #f5f5f5; }
        .modal-btn.confirm { background: #d23c32; color: #fff !important; }

        /* Toastæç¤º */
        .toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%) translateY(20px);
            padding: 12px 20px;
            border-radius: 6px;
            font-size: 14px;
            color: #fff !important;
            z-index: 99999;
            opacity: 0;
            transition: all 0.3s ease;
            min-width: 200px;
            text-align: center;
        }
        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
        .toast.success { background: #2e7d32; }
        .toast.warning { background: #f57c00; }
        .toast.error { background: #d23c32; }

        /* å“åº”å¼é€‚é… */
        @media (max-width: 768px) {
            body { padding: 10px; }
            .container { padding: 20px; }
            .form-group label { width: 70px; }
            .stats-summary { grid-template-columns: repeat(2, 1fr); }
            .chart-section { grid-template-columns: 1fr; }
            .dimension-options { max-height: 120px; }
            .filter-bottom { flex-direction: column; align-items: flex-start; gap: 15px; }
        }
    </style>
</head>
<body>
    <!-- è®¾ç½®æŒ‰é’® -->
    <div class="settings-btn" onclick="showSettingsPanel()">âš™ï¸</div>
    
    <div class="container">
        <h1>ğŸ¡ å®¶åº­è®°è´¦æœ¬</h1>
        
        <!-- è®°è´¦å½•å…¥åŒºåŸŸ -->
        <div class="input-section">
            <div class="form-group">
                <label>è®°è´¦äººï¼š</label>
                <select id="userSelect"></select>
            </div>
            <div class="form-group">
                <label>æ”¶æ”¯ç±»å‹ï¼š</label>
                <select id="typeSelect" onchange="changeCategoryOptions()">
                    <option value="æ”¯å‡º">æ”¯å‡º</option>
                    <option value="æ”¶å…¥">æ”¶å…¥</option>
                </select>
            </div>
            <div class="form-group">
                <label>æ”¶æ”¯åˆ†ç±»ï¼š</label>
                <select id="categorySelect"></select>
            </div>
            <div class="form-group">
                <label>é‡‘é¢ï¼š</label>
                <input type="number" id="amountInput" placeholder="è¯·è¾“å…¥é‡‘é¢" min="0.01" step="0.01">
            </div>
            <div class="form-group">
                <label>æ—¥æœŸï¼š</label>
                <input type="date" id="dateInput">
                <div style="display: flex; gap: 8px;">
                    <button type="button" style="padding: 6px 10px; font-size: 12px;" onclick="setQuickDate('today')">ä»Šæ—¥</button>
                    <button type="button" style="padding: 6px 10px; font-size: 12px;" onclick="setQuickDate('yesterday')">æ˜¨æ—¥</button>
                </div>
            </div>
            <div class="form-group">
                <label>å¤‡æ³¨ï¼š</label>
                <textarea id="remarkInput" placeholder="å¯é€‰ï¼Œè®°å½•è¯¦æƒ…"></textarea>
                <div class="remark-tags">
                    <div class="remark-tag" onclick="fillRemark('è¶…å¸‚é‡‡è´­')">è¶…å¸‚é‡‡è´­</div>
                    <div class="remark-tag" onclick="fillRemark('å¤–å–')">å¤–å–</div>
                    <div class="remark-tag" onclick="fillRemark('å·¥èµ„åˆ°è´¦')">å·¥èµ„åˆ°è´¦</div>
                    <div class="remark-tag" onclick="fillRemark('å…¶ä»–')">å…¶ä»–</div>
                </div>
            </div>
            <div class="form-group">
                <button id="addRecordBtn">âœ… æ·»åŠ è®°è´¦è®°å½•</button>
                <button id="editRecordBtn" class="edit-btn" style="display: none;">âœï¸ ä¿å­˜ä¿®æ”¹</button>
                <input type="hidden" id="editRecordId" value="">
            </div>
        </div>

        <!-- ========== æ ¸å¿ƒï¼šå¹´/æœˆ/æ—¥ç­›é€‰åŒºåŸŸ ========== -->
        <div class="filter-section">
            <!-- ç»´åº¦åˆ‡æ¢tab -->
            <div class="dimension-tabs">
                <div class="dimension-tab active" data-dimension="year">æŒ‰å¹´æŸ¥çœ‹</div>
                <div class="dimension-tab" data-dimension="month">æŒ‰æœˆæŸ¥çœ‹</div>
                <div class="dimension-tab" data-dimension="day">æŒ‰æ—¥æŸ¥çœ‹</div>
            </div>

            <!-- ç»´åº¦é€‰é¡¹åˆ—è¡¨ -->
            <div class="filter-content">
                <div class="dimension-options" id="dimensionOptions">
                    <!-- åŠ¨æ€ç”Ÿæˆå¹´ä»½/æœˆä»½/æ—¥æœŸé€‰é¡¹ -->
                </div>
            </div>

            <!-- åº•éƒ¨ç­›é€‰æ  -->
            <div class="filter-bottom">
                <div class="user-filter">
                    <label>è®°è´¦äººç­›é€‰ï¼š</label>
                    <div class="user-checkbox-group" id="userCheckboxGroup">
                        <!-- åŠ¨æ€ç”Ÿæˆè®°è´¦äººå¤é€‰æ¡† -->
                    </div>
                </div>
                <div class="data-op-btn">
                    <button class="data-btn export-btn" onclick="exportData()">ğŸ“¤ å¯¼å‡ºæ•°æ®</button>
                    <button class="data-btn import-btn" onclick="document.getElementById('importFile').click()">ğŸ“¥ å¯¼å…¥æ•°æ®</button>
                    <input type="file" id="importFile" accept=".json" onchange="importData(event)">
                </div>
            </div>
        </div>

        <!-- ç»Ÿè®¡åŒºåŸŸ -->
        <div class="stats-section">
            <div class="stats-title" id="statsTitle">è¯·é€‰æ‹©æŸ¥çœ‹ç»´åº¦ï¼Œç»Ÿè®¡å¯¹åº”è´¦å•é‡‘é¢</div>
            
            <!-- æ±‡æ€»æ•°æ® -->
            <div class="stats-summary">
                <div class="stats-item">
                    <div class="label">æ€»æ”¯å‡º</div>
                    <div class="value expense" id="totalExpense">0.00</div>
                </div>
                <div class="stats-item">
                    <div class="label">æ€»æ”¶å…¥</div>
                    <div class="value income" id="totalIncome">0.00</div>
                </div>
                <div class="stats-item">
                    <div class="label">ç»“ä½™</div>
                    <div class="value balance" id="totalBalance">0.00</div>
                </div>
                <div class="stats-item">
                    <div class="label">ä¸ˆå¤«æ”¯å‡º</div>
                    <div class="value expense" id="husbandExpense">0.00</div>
                </div>
                <div class="stats-item">
                    <div class="label">å¦»å­æ”¯å‡º</div>
                    <div class="value expense" id="wifeExpense">0.00</div>
                </div>
            </div>
            
            <!-- å›¾è¡¨åŒºåŸŸ -->
            <div class="chart-section">
                <div class="chart-item">
                    <div class="chart-title">æ”¶æ”¯è¶‹åŠ¿</div>
                    <div class="chart-container">
                        <canvas id="trendChart"></canvas>
                    </div>
                </div>
                <div class="chart-item">
                    <div class="chart-title">æ”¯å‡ºåˆ†ç±»å æ¯”</div>
                    <div class="chart-container">
                        <canvas id="pieChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- åˆ†ç±»æ˜ç»† -->
            <div class="category-stats">
                <div class="category-title">ğŸ“ æ”¯å‡ºåˆ†ç±»æ˜ç»†</div>
                <div class="category-grid" id="expenseCategoryGrid"></div>
            </div>
            <div class="category-stats">
                <div class="category-title">ğŸ’° æ”¶å…¥åˆ†ç±»æ˜ç»†</div>
                <div class="category-grid" id="incomeCategoryGrid"></div>
            </div>
        </div>

        <!-- è´¦å•æ˜ç»†åŒºåŸŸ -->
        <div class="records-section">
            <div class="batch-operate">
                <div class="batch-select">
                    <input type="checkbox" id="selectAll" onchange="selectAllRecords()">
                    <label for="selectAll">å…¨é€‰</label>
                    <span id="selectedCount">(0/0)</span>
                </div>
                <button class="batch-delete-btn" id="batchDeleteBtn" onclick="showBatchDeleteModal()" disabled>ğŸ—‘ï¸ æ‰¹é‡åˆ é™¤</button>
            </div>
            <table>
                <thead>
                    <tr>
                        <th class="checkbox-col">#</th>
                        <th>æ—¥æœŸ</th>
                        <th>è®°è´¦äºº</th>
                        <th>ç±»å‹</th>
                        <th>åˆ†ç±»</th>
                        <th class="amount-col">é‡‘é¢</th>
                        <th>å¤‡æ³¨</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="recordsBody"></tbody>
            </table>
        </div>
    </div>

    <!-- åˆ é™¤ç¡®è®¤å¼¹çª— -->
    <div class="modal-overlay" id="deleteModal">
        <div class="modal-box">
            <div class="modal-title">âš ï¸ ç¡®è®¤åˆ é™¤</div>
            <div class="modal-content">
                ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ<br>åˆ é™¤åæ•°æ®æ— æ³•æ¢å¤ï¼Œè¯·è°¨æ…æ“ä½œï¼
            </div>
            <div class="modal-btns">
                <button class="modal-btn cancel" onclick="hideDeleteModal()">å–æ¶ˆ</button>
                <button class="modal-btn confirm" onclick="confirmDeleteRecord()">ç¡®è®¤åˆ é™¤</button>
            </div>
        </div>
    </div>

    <!-- æ‰¹é‡åˆ é™¤å¼¹çª— -->
    <div class="modal-overlay" id="batchDeleteModal">
        <div class="modal-box">
            <div class="modal-title">âš ï¸ æ‰¹é‡åˆ é™¤ç¡®è®¤</div>
            <div class="modal-content">
                ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„æ‰€æœ‰è®°å½•å—ï¼Ÿ<br>åˆ é™¤åæ•°æ®æ— æ³•æ¢å¤ï¼Œè¯·è°¨æ…æ“ä½œï¼
            </div>
            <div class="modal-btns">
                <button class="modal-btn cancel" onclick="hideBatchDeleteModal()">å–æ¶ˆ</button>
                <button class="modal-btn confirm" onclick="confirmBatchDelete()">ç¡®è®¤åˆ é™¤</button>
            </div>
        </div>
    </div>

    <!-- è®¾ç½®é¢æ¿ -->
    <div class="settings-panel" id="settingsPanel">
        <div class="settings-header">
            <div class="settings-title">âš™ï¸ è‡ªå®šä¹‰è®¾ç½®</div>
            <div class="close-settings" onclick="hideSettingsPanel()">âœ•</div>
        </div>
        
        <!-- è‡ªå®šä¹‰è®°è´¦äºº -->
        <div class="settings-group">
            <div class="settings-group-title">ğŸ‘¥ è‡ªå®šä¹‰è®°è´¦äºº</div>
            <div id="customUsersContainer"></div>
            <button class="add-btn" onclick="addCustomItem('user')">+ æ·»åŠ è®°è´¦äºº</button>
        </div>
        
        <!-- è‡ªå®šä¹‰æ”¯å‡ºåˆ†ç±» -->
        <div class="settings-group">
            <div class="settings-group-title">ğŸ“ è‡ªå®šä¹‰æ”¯å‡ºåˆ†ç±»</div>
            <div id="customExpenseContainer"></div>
            <button class="add-btn" onclick="addCustomItem('expense')">+ æ·»åŠ æ”¯å‡ºåˆ†ç±»</button>
        </div>
        
        <!-- è‡ªå®šä¹‰æ”¶å…¥åˆ†ç±» -->
        <div class="settings-group">
            <div class="settings-group-title">ğŸ’° è‡ªå®šä¹‰æ”¶å…¥åˆ†ç±»</div>
            <div id="customIncomeContainer"></div>
            <button class="add-btn" onclick="addCustomItem('income')">+ æ·»åŠ æ”¶å…¥åˆ†ç±»</button>
        </div>
        
        <button class="save-settings" onclick="saveCustomSettings()">ğŸ’¾ ä¿å­˜æ‰€æœ‰è®¾ç½®</button>
    </div>

    <!-- Toastå®¹å™¨ -->
    <div class="toast" id="toast"></div>

    <script>
        // ========== å…¨å±€é…ç½® & å˜é‡ ==========
        const defaultConfig = {
            users: ['ä¸ˆå¤«', 'å¦»å­'],
            categories: {
                æ”¯å‡º: ['é¤é¥®', 'äº¤é€š', 'æœé¥°', 'ä½æˆ¿', 'å¨±ä¹', 'æ—¥ç”¨å“', 'åŒ»ç–—', 'è‚²å„¿', 'å…¶ä»–'],
                æ”¶å…¥: ['è–ªèµ„', 'å…¼èŒ', 'ç†è´¢', 'ç¤¼é‡‘', 'å…¶ä»–']
            }
        };
        // ç­›é€‰çŠ¶æ€ç®¡ç†
        let filterState = {
            currentDimension: 'year', // å½“å‰ç»´åº¦ï¼šyear/month/day
            selectedValue: '', // é€‰ä¸­çš„å¹´ä»½/æœˆä»½/æ—¥æœŸ
            selectedUsers: [] // é€‰ä¸­çš„è®°è´¦äºº
        };
        let waitDeleteId = null;
        let selectedRecordIds = [];
        let trendChart = null;
        let pieChart = null;

        // ========== åˆå§‹åŒ– ==========
        document.addEventListener('DOMContentLoaded', function() {
            initConfig();
            initDate();
            initUserSelect();
            initUserCheckbox();
            changeCategoryOptions();
            initDimensionTabs();
            initDimensionOptions();
            initCharts();
            initCustomSettings();
            loadRecords();
            bindEvents();
        });

        // ========== åŸºç¡€é…ç½®ç®¡ç† ==========
        function getConfig() {
            const config = localStorage.getItem('accountConfig');
            return config ? JSON.parse(config) : JSON.parse(JSON.stringify(defaultConfig));
        }

        function saveConfig(config) {
            localStorage.setItem('accountConfig', JSON.stringify(config));
            initUserSelect();
            initUserCheckbox();
            changeCategoryOptions();
            initCustomSettings();
        }

        function initConfig() {
            if (!localStorage.getItem('accountConfig')) {
                saveConfig(defaultConfig);
            }
        }

        // ========== åŸºç¡€è¡¨å•åˆå§‹åŒ– ==========
        function initDate() {
            document.getElementById('dateInput').value = new Date().toISOString().split('T')[0];
        }

        function setQuickDate(type) {
            const date = new Date();
            if (type === 'yesterday') date.setDate(date.getDate() - 1);
            document.getElementById('dateInput').value = date.toISOString().split('T')[0];
        }

        function fillRemark(text) {
            document.getElementById('remarkInput').value = text;
        }

        function initUserSelect() {
            const config = getConfig();
            const select = document.getElementById('userSelect');
            select.innerHTML = config.users.map(user => `<option value="${user}">${user}</option>`).join('');
        }

        function initUserCheckbox() {
            const config = getConfig();
            const container = document.getElementById('userCheckboxGroup');
            container.innerHTML = config.users.map(user => `
                <div class="user-checkbox-item">
                    <input type="checkbox" id="user_${user}" value="${user}" checked onchange="filterRecords()">
                    <label for="user_${user}">${user}</label>
                </div>
            `).join('');
            // åˆå§‹åŒ–é€‰ä¸­çš„è®°è´¦äºº
            filterState.selectedUsers = config.users;
        }

        function changeCategoryOptions() {
            const config = getConfig();
            const type = document.getElementById('typeSelect').value;
            const select = document.getElementById('categorySelect');
            select.innerHTML = config.categories[type].map(cat => `<option value="${cat}">${cat}</option>`).join('');
        }

        // ========== æ ¸å¿ƒï¼šå¹´/æœˆ/æ—¥ç»´åº¦ç­›é€‰é€»è¾‘ ==========
        // åˆå§‹åŒ–ç»´åº¦åˆ‡æ¢tab
        function initDimensionTabs() {
            const tabs = document.querySelectorAll('.dimension-tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    // åˆ‡æ¢æ¿€æ´»çŠ¶æ€
                    tabs.forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    // æ›´æ–°å½“å‰ç»´åº¦
                    filterState.currentDimension = this.dataset.dimension;
                    filterState.selectedValue = ''; // é‡ç½®é€‰ä¸­å€¼
                    // é‡æ–°ç”Ÿæˆå¯¹åº”ç»´åº¦çš„é€‰é¡¹
                    initDimensionOptions();
                    // é‡ç½®ç»Ÿè®¡
                    resetStats();
                });
            });
        }

        // ç”Ÿæˆå¯¹åº”ç»´åº¦çš„é€‰é¡¹åˆ—è¡¨
        function initDimensionOptions() {
            const records = getRecords();
            const dimension = filterState.currentDimension;
            const container = document.getElementById('dimensionOptions');
            container.innerHTML = '';

            // æå–æ‰€æœ‰ä¸é‡å¤çš„ç»´åº¦å€¼ï¼ŒæŒ‰æ—¶é—´å€’åºæ’åˆ—
            let valueList = [];
            records.forEach(record => {
                let value = '';
                if (dimension === 'year') value = record.date.split('-')[0]; // å¹´ä»½
                else if (dimension === 'month') value = record.date.split('-').slice(0, 2).join('-'); // å¹´æœˆ
                else if (dimension === 'day') value = record.date; // å®Œæ•´æ—¥æœŸ
                if (!valueList.includes(value)) valueList.push(value);
            });

            // å€’åºæ’åˆ—ï¼ˆæœ€æ–°çš„åœ¨æœ€å‰é¢ï¼‰
            valueList = valueList.sort((a, b) => new Date(b) - new Date(a));

            // æ— æ•°æ®æ—¶æç¤º
            if (valueList.length === 0) {
                container.innerHTML = '<div style="padding: 20px; text-align: center; color: #888; width: 100%;">æš‚æ— è®°è´¦è®°å½•ï¼Œå…ˆæ·»åŠ è®°å½•å§ï½</div>';
                return;
            }

            // ç”Ÿæˆé€‰é¡¹æŒ‰é’®
            valueList.forEach(value => {
                const option = document.createElement('div');
                option.className = 'dimension-option';
                option.dataset.value = value;
                
                // æ ¼å¼åŒ–æ˜¾ç¤ºæ–‡æœ¬
                let showText = value;
                if (dimension === 'year') showText = `${value}å¹´`;
                else if (dimension === 'month') showText = `${value.replace('-', 'å¹´')}æœˆ`;
                else if (dimension === 'day') showText = `${value.replace(/-/g, 'å¹´')}æ—¥`.replace('å¹´', 'æœˆ', 2);
                option.textContent = showText;

                // ç‚¹å‡»äº‹ä»¶ï¼šé€‰ä¸­å³ç­›é€‰ç»Ÿè®¡
                option.addEventListener('click', function() {
                    // åˆ‡æ¢æ¿€æ´»çŠ¶æ€
                    document.querySelectorAll('.dimension-option').forEach(opt => opt.classList.remove('active'));
                    this.classList.add('active');
                    // æ›´æ–°é€‰ä¸­å€¼
                    filterState.selectedValue = this.dataset.value;
                    // æ‰§è¡Œç­›é€‰å’Œç»Ÿè®¡
                    filterRecords();
                    // æ›´æ–°ç»Ÿè®¡æ ‡é¢˜
                    updateStatsTitle();
                });

                container.appendChild(option);
            });
        }

        // æ›´æ–°ç»Ÿè®¡æ ‡é¢˜
        function updateStatsTitle() {
            const { currentDimension, selectedValue } = filterState;
            const titleEl = document.getElementById('statsTitle');
            let title = '';

            if (currentDimension === 'year') title = `ğŸ“… ${selectedValue}å¹´ è´¦å•ç»Ÿè®¡`;
            else if (currentDimension === 'month') title = `ğŸ“… ${selectedValue.replace('-', 'å¹´')}æœˆ è´¦å•ç»Ÿè®¡`;
            else if (currentDimension === 'day') title = `ğŸ“… ${selectedValue.replace(/-/g, 'å¹´')}æ—¥`.replace('å¹´', 'æœˆ', 2) + ' è´¦å•ç»Ÿè®¡';
            
            titleEl.textContent = title;
        }

        // é‡ç½®ç»Ÿè®¡
        function resetStats() {
            document.getElementById('statsTitle').textContent = 'è¯·é€‰æ‹©æŸ¥çœ‹ç»´åº¦ï¼Œç»Ÿè®¡å¯¹åº”è´¦å•é‡‘é¢';
            document.getElementById('totalExpense').textContent = '0.00';
            document.getElementById('totalIncome').textContent = '0.00';
            document.getElementById('totalBalance').textContent = '0.00';
            document.getElementById('husbandExpense').textContent = '0.00';
            document.getElementById('wifeExpense').textContent = '0.00';
            document.getElementById('expenseCategoryGrid').innerHTML = '';
            document.getElementById('incomeCategoryGrid').innerHTML = '';
            document.getElementById('recordsBody').innerHTML = `
                <tr>
                    <td colspan="8" class="empty-state">è¯·é€‰æ‹©å¹´ä»½/æœˆä»½/æ—¥æœŸï¼ŒæŸ¥çœ‹å¯¹åº”è´¦å•</td>
                </tr>
            `;
            // é‡ç½®å›¾è¡¨
            if (trendChart) {
                trendChart.data.labels = [];
                trendChart.data.datasets[0].data = [];
                trendChart.data.datasets[1].data = [];
                trendChart.update();
            }
            if (pieChart) {
                pieChart.data.labels = [];
                pieChart.data.datasets[0].data = [];
                pieChart.update();
            }
        }

        // ========== æ•°æ®CRUD ==========
        function getRecords() {
            const records = localStorage.getItem('accountRecords');
            return records ? JSON.parse(records) : [];
        }

        function saveRecords(records) {
            localStorage.setItem('accountRecords', JSON.stringify(records));
            // æ–°å¢/ä¿®æ”¹è®°å½•åï¼Œæ›´æ–°ç»´åº¦é€‰é¡¹
            initDimensionOptions();
        }

        // æ ¸å¿ƒç­›é€‰é€»è¾‘
        function filterRecords() {
            const records = getRecords();
            const { currentDimension, selectedValue } = filterState;
            
            // 1. è®°è´¦äººç­›é€‰
            const checkedUsers = Array.from(document.querySelectorAll('.user-checkbox-group input:checked')).map(i => i.value);
            filterState.selectedUsers = checkedUsers;
            let filtered = records.filter(record => checkedUsers.includes(record.user));

            // 2. ç»´åº¦ç­›é€‰ï¼ˆæ ¸å¿ƒï¼‰
            if (selectedValue) {
                if (currentDimension === 'year') {
                    filtered = filtered.filter(record => record.date.startsWith(selectedValue));
                } else if (currentDimension === 'month') {
                    filtered = filtered.filter(record => record.date.startsWith(selectedValue));
                } else if (currentDimension === 'day') {
                    filtered = filtered.filter(record => record.date === selectedValue);
                }
            }

            // 3. æ¸²æŸ“å’Œç»Ÿè®¡
            renderRecords(filtered);
            calculateStats(filtered);
            renderCategoryStats(filtered);
            updateCharts(filtered);
            updateSelectedCount();
        }

        // æ¸²æŸ“è´¦å•åˆ—è¡¨
        function renderRecords(records) {
            const tbody = document.getElementById('recordsBody');
            selectedRecordIds = []; // é‡ç½®é€‰ä¸­çš„è®°å½•

            if (records.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="empty-state">è¯¥ç»´åº¦ä¸‹æš‚æ— è®°è´¦è®°å½•</td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = records.map(record => `
                <tr>
                    <td class="checkbox-col">
                        <input type="checkbox" class="record-checkbox" data-id="${record.id}" onchange="selectRecord(${record.id}, this.checked)">
                    </td>
                    <td>${record.date}</td>
                    <td>${record.user}</td>
                    <td>${record.type}</td>
                    <td>${record.category}</td>
                    <td class="amount-col">Â¥${record.amount.toFixed(2)}</td>
                    <td>${record.remark || '-'}</td>
                    <td class="operate-btn">
                        <span class="edit-btn" onclick="editRecord(${record.id})">ç¼–è¾‘</span>
                        <span class="delete-btn" onclick="showDeleteModal(${record.id})">åˆ é™¤</span>
                    </td>
                </tr>
            `).join('');
        }

        // æ·»åŠ è®°å½•
        function addRecord() {
            const user = document.getElementById('userSelect').value;
            const type = document.getElementById('typeSelect').value;
            const category = document.getElementById('categorySelect').value;
            const amount = parseFloat(document.getElementById('amountInput').value);
            const date = document.getElementById('dateInput').value;
            const remark = document.getElementById('remarkInput').value.trim();

            if (!amount || amount <= 0) {
                showToast('è¯·è¾“å…¥æœ‰æ•ˆçš„é‡‘é¢', 'warning');
                return;
            }
            if (!date) {
                showToast('è¯·é€‰æ‹©æ—¥æœŸ', 'warning');
                return;
            }

            const record = {
                id: Date.now(),
                user,
                type,
                category,
                amount,
                date,
                remark
            };

            const records = getRecords();
            records.unshift(record); // æ–°å¢çš„åœ¨æœ€å‰é¢
            saveRecords(records);
            
            // æ¸…ç©ºè¡¨å•
            document.getElementById('amountInput').value = '';
            document.getElementById('remarkInput').value = '';
            
            // é‡æ–°ç­›é€‰
            filterRecords();
            showToast('è®°è´¦è®°å½•æ·»åŠ æˆåŠŸï¼', 'success');
        }

        // ç¼–è¾‘è®°å½•
        function editRecord(id) {
            const records = getRecords();
            const record = records.find(r => r.id === id);
            if (!record) return;

            document.getElementById('userSelect').value = record.user;
            document.getElementById('typeSelect').value = record.type;
            changeCategoryOptions();
            document.getElementById('categorySelect').value = record.category;
            document.getElementById('amountInput').value = record.amount;
            document.getElementById('dateInput').value = record.date;
            document.getElementById('remarkInput').value = record.remark;
            document.getElementById('editRecordId').value = id;

            document.getElementById('addRecordBtn').style.display = 'none';
            document.getElementById('editRecordBtn').style.display = 'inline-block';
            
            // æ»šåŠ¨åˆ°é¡¶éƒ¨
            document.querySelector('.input-section').scrollIntoView({ behavior: 'smooth' });
        }

        // ä¿å­˜ç¼–è¾‘
        function saveEditRecord() {
            const id = parseInt(document.getElementById('editRecordId').value);
            const user = document.getElementById('userSelect').value;
            const type = document.getElementById('typeSelect').value;
            const category = document.getElementById('categorySelect').value;
            const amount = parseFloat(document.getElementById('amountInput').value);
            const date = document.getElementById('dateInput').value;
            const remark = document.getElementById('remarkInput').value.trim();

            if (!amount || amount <= 0) {
                showToast('è¯·è¾“å…¥æœ‰æ•ˆçš„é‡‘é¢', 'warning');
                return;
            }
            if (!date) {
                showToast('è¯·é€‰æ‹©æ—¥æœŸ', 'warning');
                return;
            }

            const records = getRecords();
            const index = records.findIndex(r => r.id === id);
            if (index === -1) return;

            records[index] = {
                ...records[index],
                user,
                type,
                category,
                amount,
                date,
                remark
            };

            saveRecords(records);
            
            // é‡ç½®è¡¨å•
            document.getElementById('addRecordBtn').style.display = 'inline-block';
            document.getElementById('editRecordBtn').style.display = 'none';
            document.getElementById('editRecordId').value = '';
            document.getElementById('amountInput').value = '';
            document.getElementById('remarkInput').value = '';
            
            // é‡æ–°ç­›é€‰
            filterRecords();
            showToast('è®°è´¦è®°å½•ä¿®æ”¹æˆåŠŸï¼', 'success');
        }

        // ========== æ‰¹é‡æ“ä½œ ==========
        function selectAllRecords() {
            const isChecked = document.getElementById('selectAll').checked;
            const checkboxes = document.querySelectorAll('.record-checkbox');
            selectedRecordIds = [];

            checkboxes.forEach(checkbox => {
                checkbox.checked = isChecked;
                if (isChecked) selectedRecordIds.push(parseInt(checkbox.dataset.id));
            });

            updateSelectedCount();
        }

        function selectRecord(id, isChecked) {
            if (isChecked) {
                if (!selectedRecordIds.includes(id)) selectedRecordIds.push(id);
            } else {
                selectedRecordIds = selectedRecordIds.filter(i => i !== id);
                document.getElementById('selectAll').checked = false;
            }
            updateSelectedCount();
        }

        function updateSelectedCount() {
            const total = document.querySelectorAll('.record-checkbox').length;
            const count = selectedRecordIds.length;
            document.getElementById('selectedCount').textContent = `(${count}/${total})`;
            document.getElementById('batchDeleteBtn').disabled = count === 0;
        }

        // ========== åˆ é™¤åŠŸèƒ½ ==========
        function showDeleteModal(id) {
            waitDeleteId = id;
            document.getElementById('deleteModal').classList.add('show');
        }

        function hideDeleteModal() {
            waitDeleteId = null;
            document.getElementById('deleteModal').classList.remove('show');
        }

        function confirmDeleteRecord() {
            if (!waitDeleteId) return;
            let records = getRecords();
            records = records.filter(r => r.id !== waitDeleteId);
            saveRecords(records);
            
            filterRecords();
            hideDeleteModal();
            showToast('è®°å½•åˆ é™¤æˆåŠŸï¼', 'success');
            waitDeleteId = null;
        }

        function showBatchDeleteModal() {
            if (selectedRecordIds.length === 0) {
                showToast('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„è®°å½•', 'warning');
                return;
            }
            document.getElementById('batchDeleteModal').classList.add('show');
        }

        function hideBatchDeleteModal() {
            document.getElementById('batchDeleteModal').classList.remove('show');
        }

        function confirmBatchDelete() {
            let records = getRecords();
            records = records.filter(r => !selectedRecordIds.includes(r.id));
            saveRecords(records);
            
            selectedRecordIds = [];
            document.getElementById('selectAll').checked = false;
            filterRecords();
            hideBatchDeleteModal();
            showToast('æ‰¹é‡åˆ é™¤æˆåŠŸï¼', 'success');
        }

        // ========== ç»Ÿè®¡è®¡ç®— ==========
        function calculateStats(records) {
            let totalExpense = 0, totalIncome = 0, husbandExpense = 0, wifeExpense = 0;

            records.forEach(record => {
                if (record.type === 'æ”¯å‡º') {
                    totalExpense += record.amount;
                    if (record.user === 'ä¸ˆå¤«') husbandExpense += record.amount;
                    if (record.user === 'å¦»å­') wifeExpense += record.amount;
                } else {
                    totalIncome += record.amount;
                }
            });

            const totalBalance = totalIncome - totalExpense;

            // æ›´æ–°DOM
            document.getElementById('totalExpense').textContent = totalExpense.toFixed(2);
            document.getElementById('totalIncome').textContent = totalIncome.toFixed(2);
            document.getElementById('totalBalance').textContent = totalBalance.toFixed(2);
            document.getElementById('husbandExpense').textContent = husbandExpense.toFixed(2);
            document.getElementById('wifeExpense').textContent = wifeExpense.toFixed(2);
        }

        // åˆ†ç±»æ˜ç»†ç»Ÿè®¡
        function renderCategoryStats(records) {
            const config = getConfig();
            const expenseMap = {}, incomeMap = {};
            
            // åˆå§‹åŒ–åˆ†ç±»
            config.categories.æ”¯å‡º.forEach(cat => expenseMap[cat] = 0);
            config.categories.æ”¶å…¥.forEach(cat => incomeMap[cat] = 0);
            
            // ç´¯åŠ é‡‘é¢
            records.forEach(record => {
                if (record.type === 'æ”¯å‡º') expenseMap[record.category] = (expenseMap[record.category] || 0) + record.amount;
                else incomeMap[record.category] = (incomeMap[record.category] || 0) + record.amount;
            });

            // æ¸²æŸ“æ”¯å‡ºåˆ†ç±»
            const expenseGrid = document.getElementById('expenseCategoryGrid');
            expenseGrid.innerHTML = Object.entries(expenseMap).map(([cat, amount]) => {
                if (amount <= 0) return '';
                return `
                    <div class="category-item">
                        <div class="name">${cat}</div>
                        <div class="value expense">Â¥${amount.toFixed(2)}</div>
                    </div>
                `;
            }).join('');

            // æ¸²æŸ“æ”¶å…¥åˆ†ç±»
            const incomeGrid = document.getElementById('incomeCategoryGrid');
            incomeGrid.innerHTML = Object.entries(incomeMap).map(([cat, amount]) => {
                if (amount <= 0) return '';
                return `
                    <div class="category-item">
                        <div class="name">${cat}</div>
                        <div class="value income">Â¥${amount.toFixed(2)}</div>
                    </div>
                `;
            }).join('');
        }

        // ========== å›¾è¡¨åŠŸèƒ½ ==========
        function initCharts() {
            // è¶‹åŠ¿å›¾
            const trendCtx = document.getElementById('trendChart').getContext('2d');
            trendChart = new Chart(trendCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        { label: 'æ”¯å‡º', data: [], borderColor: '#d23c32', backgroundColor: 'rgba(210,60,50,0.1)', tension: 0.3, fill: true },
                        { label: 'æ”¶å…¥', data: [], borderColor: '#2e7d32', backgroundColor: 'rgba(46,125,50,0.1)', tension: 0.3, fill: true }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true, ticks: { callback: v => `Â¥${v}` } } },
                    plugins: { tooltip: { callbacks: { label: ctx => `Â¥${ctx.raw.toFixed(2)}` } } }
                }
            });

            // é¥¼å›¾
            const pieCtx = document.getElementById('pieChart').getContext('2d');
            pieChart = new Chart(pieCtx, {
                type: 'doughnut',
                data: { labels: [], datasets: [{ data: [], backgroundColor: [] }] },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { tooltip: { callbacks: { label: ctx => `${ctx.label}: Â¥${ctx.raw.toFixed(2)}` } } }
                }
            });
        }

        function updateCharts(records) {
            const { currentDimension } = filterState;
            const groupMap = {};
            const expenseCategoryMap = {};
            const colors = ['#d23c32', '#f57c00', '#0277bd', '#2e7d32', '#7b1fa2', '#5d4037', '#0097a7', '#ff5722'];

            // è¶‹åŠ¿å›¾æ•°æ®åˆ†ç»„
            records.forEach(record => {
                let key = '';
                if (currentDimension === 'year') key = record.date.split('-')[1] + 'æœˆ';
                else if (currentDimension === 'month') key = record.date.split('-')[2] + 'æ—¥';
                else key = record.date;

                if (!groupMap[key]) groupMap[key] = { expense: 0, income: 0 };
                if (record.type === 'æ”¯å‡º') groupMap[key].expense += record.amount;
                else groupMap[key].income += record.amount;

                // é¥¼å›¾æ•°æ®
                if (record.type === 'æ”¯å‡º') {
                    expenseCategoryMap[record.category] = (expenseCategoryMap[record.category] || 0) + record.amount;
                }
            });

            // æ›´æ–°è¶‹åŠ¿å›¾
            const sortedKeys = Object.keys(groupMap).sort();
            trendChart.data.labels = sortedKeys;
            trendChart.data.datasets[0].data = sortedKeys.map(k => groupMap[k].expense);
            trendChart.data.datasets[1].data = sortedKeys.map(k => groupMap[k].income);
            trendChart.update();

            // æ›´æ–°é¥¼å›¾
            const categories = Object.keys(expenseCategoryMap);
            const values = categories.map(cat => expenseCategoryMap[cat]);
            const bgColors = categories.map((_, i) => colors[i % colors.length]);

            // æ›´æ–°é¥¼å›¾
            pieChart.data.labels = categories;
            pieChart.data.datasets[0].data = values;
            pieChart.data.datasets[0].backgroundColor = bgColors;
            pieChart.update();
        }

        // ========== æ•°æ®å¯¼å…¥å¯¼å‡º ==========
        function exportData() {
            const records = getRecords();
            const config = getConfig();
            const exportData = {
                records: records,
                config: config,
                exportTime: new Date().toLocaleString()
            };

            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `å®¶åº­è®°è´¦æœ¬_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            showToast('æ•°æ®å¯¼å‡ºæˆåŠŸï¼', 'success');
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.records) saveRecords(data.records);
                    if (data.config) saveConfig(data.config);
                    
                    // åˆ·æ–°é¡µé¢æ‰€æœ‰çŠ¶æ€
                    initDimensionOptions();
                    filterRecords();
                    showToast('æ•°æ®å¯¼å…¥æˆåŠŸï¼', 'success');
                } catch (err) {
                    showToast('å¯¼å…¥å¤±è´¥ï¼Œæ–‡ä»¶æ ¼å¼é”™è¯¯', 'error');
                }
            };
            reader.readAsText(file);
            event.target.value = ''; // æ¸…ç©ºè¾“å…¥ï¼Œå…è®¸é‡å¤é€‰æ‹©
        }

        // ========== è‡ªå®šä¹‰è®¾ç½®é¢æ¿ ==========
        function showSettingsPanel() {
            document.getElementById('settingsPanel').classList.add('show');
            initCustomSettings();
        }

        function hideSettingsPanel() {
            document.getElementById('settingsPanel').classList.remove('show');
        }

        function initCustomSettings() {
            const config = getConfig();
            // æ¸²æŸ“è‡ªå®šä¹‰è®°è´¦äºº
            renderCustomItems('customUsersContainer', config.users);
            // æ¸²æŸ“è‡ªå®šä¹‰æ”¯å‡ºåˆ†ç±»
            renderCustomItems('customExpenseContainer', config.categories.æ”¯å‡º);
            // æ¸²æŸ“è‡ªå®šä¹‰æ”¶å…¥åˆ†ç±»
            renderCustomItems('customIncomeContainer', config.categories.æ”¶å…¥);
        }

        function renderCustomItems(containerId, items) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            items.forEach(item => {
                const div = document.createElement('div');
                div.className = 'custom-item';
                div.innerHTML = `
                    <input type="text" value="${item}" placeholder="è¯·è¾“å…¥åç§°">
                    <button class="custom-btn" onclick="deleteCustomItem(this)">âœ•</button>
                `;
                container.appendChild(div);
            });
        }

        function addCustomItem(type) {
            let containerId = '';
            let placeholder = '';
            if (type === 'user') {
                containerId = 'customUsersContainer';
                placeholder = 'è¯·è¾“å…¥è®°è´¦äººåç§°';
            } else if (type === 'expense') {
                containerId = 'customExpenseContainer';
                placeholder = 'è¯·è¾“å…¥æ”¯å‡ºåˆ†ç±»';
            } else if (type === 'income') {
                containerId = 'customIncomeContainer';
                placeholder = 'è¯·è¾“å…¥æ”¶å…¥åˆ†ç±»';
            }

            const container = document.getElementById(containerId);
            const div = document.createElement('div');
            div.className = 'custom-item';
            div.innerHTML = `
                <input type="text" placeholder="${placeholder}">
                <button class="custom-btn" onclick="deleteCustomItem(this)">âœ•</button>
            `;
            container.appendChild(div);
        }

        function deleteCustomItem(el) {
            el.closest('.custom-item').remove();
        }

        function saveCustomSettings() {
            const config = getConfig();
            
            // ä¿å­˜è®°è´¦äºº
            const userInputs = document.querySelectorAll('#customUsersContainer .custom-item input');
            const users = Array.from(userInputs).map(input => input.value.trim()).filter(Boolean);
            if (users.length === 0) {
                showToast('è®°è´¦äººä¸èƒ½ä¸ºç©º', 'warning');
                return;
            }
            config.users = users;

            // ä¿å­˜æ”¯å‡ºåˆ†ç±»
            const expenseInputs = document.querySelectorAll('#customExpenseContainer .custom-item input');
            const expenseCategories = Array.from(expenseInputs).map(input => input.value.trim()).filter(Boolean);
            if (expenseCategories.length === 0) {
                showToast('æ”¯å‡ºåˆ†ç±»ä¸èƒ½ä¸ºç©º', 'warning');
                return;
            }
            config.categories.æ”¯å‡º = expenseCategories;

            // ä¿å­˜æ”¶å…¥åˆ†ç±»
            const incomeInputs = document.querySelectorAll('#customIncomeContainer .custom-item input');
            const incomeCategories = Array.from(incomeInputs).map(input => input.value.trim()).filter(Boolean);
            if (incomeCategories.length === 0) {
                showToast('æ”¶å…¥åˆ†ç±»ä¸èƒ½ä¸ºç©º', 'warning');
                return;
            }
            config.categories.æ”¶å…¥ = incomeCategories;

            // ä¿å­˜é…ç½®å¹¶åˆ·æ–°é¡µé¢çŠ¶æ€
            saveConfig(config);
            hideSettingsPanel();
            showToast('è‡ªå®šä¹‰è®¾ç½®ä¿å­˜æˆåŠŸï¼', 'success');
        }

        // ========== å…¨å±€æç¤ºåŠŸèƒ½ ==========
        function showToast(text, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = text;
            toast.className = `toast ${type}`;
            toast.classList.add('show');

            clearTimeout(toast.timer);
            toast.timer = setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // ========== äº‹ä»¶ç»‘å®š ==========
        function bindEvents() {
            // æ·»åŠ è®°å½•æŒ‰é’®
            document.getElementById('addRecordBtn').addEventListener('click', addRecord);
            // ä¿å­˜ä¿®æ”¹æŒ‰é’®
            document.getElementById('editRecordBtn').addEventListener('click', saveEditRecord);
        }
    </script>
</body>
</html>
