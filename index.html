<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¸©é¦¨å®¶åº­è®°è´¦æœ¬</title>
    <style>
        /* å…¨å±€æ ·å¼ - é«˜çº§è´¨æ„Ÿé£æ ¼ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Inter", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif;
            color: #4a4a48;
            font-weight: 400;
        }
        body {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f2ed;
            min-height: 100vh;
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%23d9d6d0' fill-opacity='0.2' fill-rule='evenodd'/%3E%3C/svg%3E");
        }
        .container {
            background: #ffffff;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 8px 24px rgba(150, 140, 130, 0.06);
            border: 1px solid rgba(233, 230, 225, 0.6);
        }
        h1 {
            text-align: center;
            color: #c87065;
            margin-bottom: 30px;
            letter-spacing: 2px;
            font-weight: 500;
            font-size: 22px;
        }

        /* å½•å…¥åŒºåŸŸæ ·å¼ */
        .input-section {
            border-bottom: 1px solid #e9e6e1;
            padding-bottom: 25px;
            margin-bottom: 25px;
        }
        .form-group {
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        .form-group label {
            width: 80px;
            color: #5c5c59;
            font-weight: 500;
            flex-shrink: 0;
        }
        .form-group select, 
        .form-group input, 
        .form-group textarea {
            flex: 1;
            min-width: 200px;
            padding: 12px 15px;
            border: 1px solid #e9e6e1;
            border-radius: 10px;
            font-size: 14px;
            background: #ffffff;
            transition: all 0.3s ease;
        }
        .form-group select:focus, 
        .form-group input:focus, 
        .form-group textarea:focus {
            outline: none;
            border-color: #c87065;
            box-shadow: 0 0 0 3px rgba(200, 112, 101, 0.08);
        }
        .form-group button {
            background: #c87065;
            color: white !important;
            border: none;
            padding: 12px 30px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 500;
            transition: background 0.3s ease;
            flex-shrink: 0;
        }
        .form-group button:hover {
            background: #b46056;
        }
        .form-group .edit-btn {
            background: #7a9d7a; /* ä¿®æ”¹æŒ‰é’®ç”¨æ”¶å…¥çš„é¼ å°¾è‰ç»¿ï¼ŒåŒºåˆ†æ·»åŠ  */
        }
        .form-group .edit-btn:hover {
            background: #6a8d6a;
        }

        /* ç­›é€‰åŒºåŸŸ - æ–°å¢æ—¥å†é€‰æ‹©å™¨æ ·å¼ */
        .filter-section {
            margin-bottom: 25px;
            padding: 15px;
            background: #ffffff;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(150, 140, 130, 0.04);
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: flex-start;
            border: 1px solid #e9e6e1;
        }
        .filter-section label {
            font-weight: 500;
            color: #5c5c59;
            flex-shrink: 0;
            margin-top: 5px;
        }
        .filter-section select {
            padding: 10px 12px;
            border: 1px solid #e9e6e1;
            border-radius: 8px;
            flex-shrink: 0;
            min-width: 120px;
            transition: border 0.3s ease;
        }
        .filter-section select:focus {
            border-color: #c87065;
            outline: none;
        }
        /* æ—¥å†é€‰æ‹©å™¨å®¹å™¨ */
        .calendar-picker {
            flex: 1;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: 8px;
            margin-top: 5px;
        }
        /* æ—¥æœŸ/æœˆä»½/å¹´ä»½æŒ‰é’® */
        .calendar-btn {
            padding: 10px 0;
            border: 1px solid #e9e6e1;
            border-radius: 8px;
            background: #f8f6f3;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 14px;
        }
        .calendar-btn:hover {
            background: #f0ece7;
            border-color: #d9d6d0;
        }
        .calendar-btn.active {
            background: #c87065;
            color: white !important;
            border-color: #c87065;
        }
        .filter-section .query-btn {
            background: #c87065;
            color: white !important;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s ease;
            flex-shrink: 0;
            margin-top: 5px;
        }
        .filter-section .query-btn:hover {
            background: #b46056;
        }

        /* ç»Ÿè®¡åŒºåŸŸ */
        .stats-section {
            margin-bottom: 25px;
            padding: 20px;
            background: #ffffff;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(150, 140, 130, 0.04);
            border: 1px solid #e9e6e1;
        }
        .stats-title {
            font-weight: 500;
            color: #c87065;
            margin-bottom: 15px;
            font-size: 16px;
        }
        .stats-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .stats-item {
            padding: 15px;
            background: #f8f6f3;
            border-radius: 8px;
            text-align: center;
            transition: transform 0.2s ease;
            border: 1px solid #e9e6e1;
        }
        .stats-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(150, 140, 130, 0.08);
        }
        .stats-item .label {
            font-size: 13px;
            color: #8a8a86;
            margin-bottom: 8px;
            font-weight: 400;
        }
        .stats-item .value {
            font-size: 18px;
            font-weight: 500;
        }
        .expense {
            color: #d49667;
        }
        .income {
            color: #7a9d7a;
        }
        .balance {
            color: #c87065;
        }

        /* åˆ†ç±»æ˜ç»†ç»Ÿè®¡ */
        .category-stats {
            margin-top: 20px;
        }
        .category-title {
            font-size: 15px;
            font-weight: 500;
            margin-bottom: 10px;
            color: #5c5c59;
        }
        .category-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
        }
        .category-item {
            padding: 10px;
            background: #f8f6f3;
            border-radius: 6px;
            font-size: 14px;
            border: 1px solid #e9e6e1;
        }
        .category-item .name {
            color: #8a8a86;
            font-size: 12px;
            margin-bottom: 5px;
        }

        /* æ˜ç»†åŒºåŸŸ */
        .records-section {
            background: #ffffff;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(150, 140, 130, 0.04);
            overflow: hidden;
            border: 1px solid #e9e6e1;
        }
        .records-section table {
            width: 100%;
            border-collapse: collapse;
        }
        .records-section th, .records-section td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e9e6e1;
        }
        .records-section th {
            background: #f8f6f3;
            color: #5c5c59;
            font-weight: 500;
            font-size: 14px;
        }
        .records-section tr:hover {
            background: #faf9f7;
        }
        .operate-btn {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .edit-btn {
            color: #7a9d7a;
            cursor: pointer;
            font-size: 13px;
            transition: color 0.3s ease;
        }
        .edit-btn:hover {
            color: #6a8d6a;
        }
        .delete-btn {
            color: #c87065;
            cursor: pointer;
            font-size: 13px;
            transition: color 0.3s ease;
        }
        .delete-btn:hover {
            color: #b46056;
        }

        /* è‡ªå®šä¹‰åˆ é™¤ç¡®è®¤å¼¹çª— */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        .modal-box {
            background: #ffffff;
            border-radius: 16px;
            padding: 30px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 8px 24px rgba(150, 140, 130, 0.15);
            transform: translateY(20px);
            transition: transform 0.3s ease;
        }
        .modal-overlay.show .modal-box {
            transform: translateY(0);
        }
        .modal-title {
            font-size: 18px;
            font-weight: 500;
            color: #4a4a48;
            margin-bottom: 15px;
            text-align: center;
        }
        .modal-content {
            font-size: 14px;
            color: #5c5c59;
            margin-bottom: 25px;
            text-align: center;
            line-height: 1.6;
        }
        .modal-btns {
            display: flex;
            gap: 15px;
            justify-content: center;
        }
        .modal-btn {
            padding: 10px 25px;
            border-radius: 10px;
            border: none;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        .modal-btn.cancel {
            background: #f8f6f3;
            color: #5c5c59;
        }
        .modal-btn.cancel:hover {
            background: #f0ece7;
        }
        .modal-btn.confirm {
            background: #c87065;
            color: white !important;
        }
        .modal-btn.confirm:hover {
            background: #b46056;
        }

        /* å“åº”å¼é€‚é… */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            .container {
                padding: 20px;
                border-radius: 12px;
            }
            .form-group {
                gap: 10px;
            }
            .form-group label {
                width: 70px;
            }
            .stats-summary {
                grid-template-columns: repeat(2, 1fr);
            }
            .operate-btn {
                flex-direction: column;
                gap: 5px;
                align-items: flex-start;
            }
            .calendar-picker {
                grid-template-columns: repeat(auto-fill, minmax(50px, 1fr));
            }
            .modal-box {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¡ æ¸©é¦¨å®¶åº­è®°è´¦æœ¬</h1>
        
        <!-- è®°è´¦å½•å…¥åŒºåŸŸ -->
        <div class="input-section">
            <div class="form-group">
                <label>è®°è´¦äººï¼š</label>
                <select id="userSelect">
                    <option value="ä¸ˆå¤«">ä¸ˆå¤«</option>
                    <option value="å¦»å­">å¦»å­</option>
                </select>
            </div>
            <div class="form-group">
                <label>æ”¶æ”¯ç±»å‹ï¼š</label>
                <select id="typeSelect" onchange="changeCategoryOptions()">
                    <option value="æ”¯å‡º">æ”¯å‡º</option>
                    <option value="æ”¶å…¥">æ”¶å…¥</option>
                </select>
            </div>
            <div class="form-group">
                <label>å…·ä½“åˆ†ç±»ï¼š</label>
                <select id="categorySelect">
                    <!-- åŠ¨æ€ç”Ÿæˆåˆ†ç±»é€‰é¡¹ -->
                </select>
            </div>
            <div class="form-group">
                <label>é‡‘é¢ï¼š</label>
                <input type="number" id="amountInput" placeholder="è¯·è¾“å…¥é‡‘é¢" min="0.01" step="0.01">
            </div>
            <div class="form-group">
                <label>æ—¥æœŸï¼š</label>
                <input type="date" id="dateInput">
            </div>
            <div class="form-group">
                <label>å¤‡æ³¨ï¼š</label>
                <textarea id="remarkInput" placeholder="è®°å½•æ¶ˆè´¹/æ”¶å…¥åŸå› ï¼ˆå¯é€‰ï¼‰"></textarea>
            </div>
            <div class="form-group">
                <button id="addRecordBtn">âœ¨ æ·»åŠ è®°è´¦è®°å½•</button>
                <button id="editRecordBtn" class="edit-btn" style="display: none;">âœï¸ ä¿å­˜ä¿®æ”¹</button>
                <!-- éšè—çš„ä¿®æ”¹IDå­˜å‚¨ -->
                <input type="hidden" id="editRecordId" value="">
            </div>
        </div>

        <!-- ç­›é€‰åŒºåŸŸ - é‡æ„ä¸ºæ—¥å†é€‰æ‹©å™¨ -->
        <div class="filter-section">
            <label>æŸ¥çœ‹ç»´åº¦ï¼š</label>
            <select id="viewDimension" onchange="renderCalendarPicker()">
                <option value="day">æŒ‰æ—¥æŸ¥çœ‹</option>
                <option value="month">æŒ‰æœˆæŸ¥çœ‹</option>
                <option value="year">æŒ‰å¹´æŸ¥çœ‹</option>
            </select>
            <!-- æ—¥å†é€‰æ‹©å™¨å®¹å™¨ -->
            <div class="calendar-picker" id="calendarPicker">
                <!-- åŠ¨æ€ç”Ÿæˆæ—¥æœŸ/æœˆä»½/å¹´ä»½æŒ‰é’® -->
            </div>
            <button class="query-btn" id="filterBtn">ğŸ” æŸ¥è¯¢</button>
        </div>

        <!-- ç»Ÿè®¡åŒºåŸŸ -->
        <div class="stats-section">
            <div class="stats-title" id="statsTitle">å½“æ—¥ç»Ÿè®¡ï¼ˆé»˜è®¤ä»Šæ—¥ï¼‰</div>
            
            <!-- æ±‡æ€»æ•°æ® - å®¶åº­æ€»æ”¯å‡º -->
            <div class="stats-summary">
                <div class="stats-item">
                    <div class="label">ä¸ˆå¤«æ”¯å‡º</div>
                    <div class="value expense" id="husbandExpense">0.00</div>
                </div>
                <div class="stats-item">
                    <div class="label">å¦»å­æ”¯å‡º</div>
                    <div class="value expense" id="wifeExpense">0.00</div>
                </div>
                <div class="stats-item">
                    <div class="label">å®¶åº­æ€»æ”¯å‡º</div>
                    <div class="value expense" id="totalExpense">0.00</div>
                </div>
                <div class="stats-item">
                    <div class="label">å®¶åº­æ€»æ”¶å…¥</div>
                    <div class="value income" id="totalIncome">0.00</div>
                </div>
                <div class="stats-item">
                    <div class="label">å®¶åº­æ€»ä½™é¢</div>
                    <div class="value balance" id="totalBalance">0.00</div>
                </div>
            </div>

            <!-- æ”¯å‡ºåˆ†ç±»æ˜ç»† -->
            <div class="category-stats" id="expenseCategoryStats">
                <div class="category-title">ğŸ“ æ”¯å‡ºåˆ†ç±»æ˜ç»†</div>
                <div class="category-grid" id="expenseCategoryGrid">
                    <!-- åŠ¨æ€ç”Ÿæˆæ”¯å‡ºåˆ†ç±»ç»Ÿè®¡ -->
                </div>
            </div>

            <!-- æ”¶å…¥åˆ†ç±»æ˜ç»† -->
            <div class="category-stats" id="incomeCategoryStats">
                <div class="category-title">ğŸ’° æ”¶å…¥åˆ†ç±»æ˜ç»†</div>
                <div class="category-grid" id="incomeCategoryGrid">
                    <!-- åŠ¨æ€ç”Ÿæˆæ”¶å…¥åˆ†ç±»ç»Ÿè®¡ -->
                </div>
            </div>
        </div>

        <!-- è®°è´¦æ˜ç»†åŒºåŸŸ -->
        <div class="records-section">
            <table>
                <thead>
                    <tr>
                        <th>æ—¥æœŸ</th>
                        <th>è®°è´¦äºº</th>
                        <th>æ”¶æ”¯ç±»å‹</th>
                        <th>å…·ä½“åˆ†ç±»</th>
                        <th>é‡‘é¢</th>
                        <th>å¤‡æ³¨</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="recordsBody">
                    <!-- åŠ¨æ€æ¸²æŸ“è®°è´¦è®°å½• -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- è‡ªå®šä¹‰åˆ é™¤ç¡®è®¤å¼¹çª— -->
    <div class="modal-overlay" id="deleteModal">
        <div class="modal-box">
            <div class="modal-title">âš ï¸ ç¡®è®¤åˆ é™¤</div>
            <div class="modal-content">
                ä½ ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°è´¦è®°å½•å—ï¼Ÿ<br>åˆ é™¤åæ•°æ®å°†<strong>æ— æ³•æ¢å¤</strong>ï¼Œè¯·è°¨æ…æ“ä½œï¼
            </div>
            <div class="modal-btns">
                <button class="modal-btn cancel" onclick="hideDeleteModal()">å–æ¶ˆ</button>
                <button class="modal-btn confirm" onclick="confirmDeleteRecord()">ç¡®è®¤åˆ é™¤</button>
            </div>
        </div>
    </div>

    <script>
        // å®šä¹‰å¤šçº§åˆ†ç±»æ•°æ®
        const categoryData = {
            æ”¯å‡º: ['é¤é¥®', 'æœé¥°', 'ä½æˆ¿', 'äº¤é€š', 'å¨±ä¹', 'æ—¥ç”¨å“', 'åŒ»ç–—', 'è‚²å„¿', 'å…¶ä»–'],
            æ”¶å…¥: ['è–ªèµ„', 'å…¼èŒ', 'ç†è´¢', 'ç¤¼é‡‘', 'å…¶ä»–']
        };

        // å…¨å±€å˜é‡ï¼šå­˜å‚¨å½“å‰é€‰ä¸­çš„æ—¥æœŸ/æœˆä»½/å¹´ä»½ã€å¾…åˆ é™¤çš„è®°å½•ID
        let currentSelectValue = '';
        let waitDeleteRecordId = null;

        // é¡µé¢åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // è®¾ç½®é»˜è®¤æ—¥æœŸä¸ºä»Šå¤©
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('dateInput').value = today;
            
            // åˆå§‹åŒ–åˆ†ç±»é€‰é¡¹
            changeCategoryOptions();
            // åˆå§‹åŒ–æ—¥å†é€‰æ‹©å™¨
            renderCalendarPicker();
            // åŠ è½½æœ¬åœ°æ•°æ®
            loadRecords();
            // åˆå§‹åŒ–ç»Ÿè®¡
            filterRecords();

            // ç»‘å®šæŒ‰é’®äº‹ä»¶
            document.getElementById('addRecordBtn').addEventListener('click', addRecord);
            document.getElementById('editRecordBtn').addEventListener('click', saveEditRecord);
            document.getElementById('filterBtn').addEventListener('click', filterRecords);
        });

        // 1. åˆ‡æ¢æ”¶æ”¯ç±»å‹æ—¶ï¼Œæ›´æ–°å…·ä½“åˆ†ç±»é€‰é¡¹
        function changeCategoryOptions() {
            const typeSelect = document.getElementById('typeSelect');
            const categorySelect = document.getElementById('categorySelect');
            const currentType = typeSelect.value;
            const categories = categoryData[currentType];

            categorySelect.innerHTML = '';
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                categorySelect.appendChild(option);
            });
        }

        // 2. æ¸²æŸ“æ—¥å†é€‰æ‹©å™¨ï¼ˆæ ¸å¿ƒï¼šæ—¥/æœˆ/å¹´ç»´åº¦åˆ‡æ¢ï¼‰
        function renderCalendarPicker() {
            const dimension = document.getElementById('viewDimension').value;
            const calendarPicker = document.getElementById('calendarPicker');
            calendarPicker.innerHTML = '';
            const today = new Date();
            
            // æ›´æ–°ç»Ÿè®¡æ ‡é¢˜
            const statsTitle = document.getElementById('statsTitle');
            
            if (dimension === 'day') {
                // æ—¥ç»´åº¦ï¼šç”Ÿæˆå½“æœˆæ‰€æœ‰å¤©æ•°
                const year = today.getFullYear();
                const month = today.getMonth();
                // è·å–å½“æœˆç¬¬ä¸€å¤©å’Œæœ€åä¸€å¤©
                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                const totalDays = lastDay.getDate();
                
                // é»˜è®¤é€‰ä¸­ä»Šå¤©
                const defaultDay = today.getDate();
                currentSelectValue = `${year}-${String(month + 1).padStart(2, '0')}-${String(defaultDay).padStart(2, '0')}`;
                
                // ç”Ÿæˆå¤©æ•°æŒ‰é’®
                for (let i = 1; i <= totalDays; i++) {
                    const dayStr = String(i).padStart(2, '0');
                    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${dayStr}`;
                    const btn = createCalendarBtn(dayStr, dateStr, dateStr === currentSelectValue);
                    calendarPicker.appendChild(btn);
                }
                
                statsTitle.textContent = `ğŸ“… å½“æ—¥ç»Ÿè®¡ï¼ˆ${currentSelectValue}ï¼‰`;
            } else if (dimension === 'month') {
                // æœˆç»´åº¦ï¼šç”Ÿæˆå½“å¹´æ‰€æœ‰æœˆä»½
                const year = today.getFullYear();
                const months = ['01', '02', '03', '04', '05', '06', '07', '08', '09', '10', '11', '12'];
                // é»˜è®¤é€‰ä¸­å½“æœˆ
                const defaultMonth = String(today.getMonth() + 1).padStart(2, '0');
                currentSelectValue = `${year}-${defaultMonth}`;
                
                // ç”Ÿæˆæœˆä»½æŒ‰é’®
                months.forEach(month => {
                    const monthName = `${month}æœˆ`;
                    const monthStr = `${year}-${month}`;
                    const btn = createCalendarBtn(monthName, monthStr, monthStr === currentSelectValue);
                    calendarPicker.appendChild(btn);
                });
                
                statsTitle.textContent = `ğŸ“† å½“æœˆç»Ÿè®¡ï¼ˆ${currentSelectValue}ï¼‰`;
            } else if (dimension === 'year') {
                // å¹´ç»´åº¦ï¼šç”Ÿæˆè¿‘5å¹´
                const currentYear = today.getFullYear();
                const years = [];
                for (let i = currentYear; i >= currentYear - 4; i--) {
                    years.push(i);
                }
                // é»˜è®¤é€‰ä¸­å½“å¹´
                currentSelectValue = `${currentYear}`;
                
                // ç”Ÿæˆå¹´ä»½æŒ‰é’®
                years.forEach(year => {
                    const yearStr = `${year}`;
                    const btn = createCalendarBtn(yearStr + 'å¹´', yearStr, yearStr === currentSelectValue);
                    calendarPicker.appendChild(btn);
                });
                
                statsTitle.textContent = `ğŸ“ˆ å½“å¹´ç»Ÿè®¡ï¼ˆ${currentSelectValue}ï¼‰`;
            }
        }

        // 3. åˆ›å»ºæ—¥å†æŒ‰é’®ï¼ˆå·¥å…·å‡½æ•°ï¼‰
        function createCalendarBtn(text, value, isActive) {
            const btn = document.createElement('div');
            btn.className = `calendar-btn ${isActive ? 'active' : ''}`;
            btn.textContent = text;
            btn.dataset.value = value;
            
            // ç‚¹å‡»åˆ‡æ¢é€‰ä¸­çŠ¶æ€
            btn.addEventListener('click', function() {
                // ç§»é™¤æ‰€æœ‰æŒ‰é’®çš„activeç±»
                document.querySelectorAll('.calendar-btn').forEach(item => {
                    item.classList.remove('active');
                });
                // æ·»åŠ å½“å‰æŒ‰é’®çš„activeç±»
                this.classList.add('active');
                // æ›´æ–°é€‰ä¸­å€¼
                currentSelectValue = this.dataset.value;
                // æ›´æ–°ç»Ÿè®¡æ ‡é¢˜
                const dimension = document.getElementById('viewDimension').value;
                const statsTitle = document.getElementById('statsTitle');
                if (dimension === 'day') {
                    statsTitle.textContent = `ğŸ“… å½“æ—¥ç»Ÿè®¡ï¼ˆ${currentSelectValue}ï¼‰`;
                } else if (dimension === 'month') {
                    statsTitle.textContent = `ğŸ“† å½“æœˆç»Ÿè®¡ï¼ˆ${currentSelectValue}ï¼‰`;
                } else if (dimension === 'year') {
                    statsTitle.textContent = `ğŸ“ˆ å½“å¹´ç»Ÿè®¡ï¼ˆ${currentSelectValue}ï¼‰`;
                }
            });
            
            return btn;
        }

        // 4. æœ¬åœ°å­˜å‚¨æ“ä½œ - è·å–æ‰€æœ‰è®°å½•
        function getRecords() {
            const records = localStorage.getItem('familyAccountRecords');
            return records ? JSON.parse(records) : [];
        }

        // 5. æœ¬åœ°å­˜å‚¨æ“ä½œ - ä¿å­˜è®°å½•
        function saveRecords(records) {
            localStorage.setItem('familyAccountRecords', JSON.stringify(records));
        }

        // 6. æ·»åŠ è®°è´¦è®°å½•
        function addRecord() {
            // è·å–è¡¨å•æ•°æ®
            const user = document.getElementById('userSelect').value;
            const type = document.getElementById('typeSelect').value;
            const category = document.getElementById('categorySelect').value;
            const amount = parseFloat(document.getElementById('amountInput').value);
            const date = document.getElementById('dateInput').value;
            const remark = document.getElementById('remarkInput').value.trim();

            // è¡¨å•éªŒè¯
            if (!amount || isNaN(amount) || amount <= 0) {
                alert('ğŸ’¡ è¯·è¾“å…¥æœ‰æ•ˆçš„é‡‘é¢ï¼ˆå¤§äº0ï¼‰ï¼');
                return;
            }
            if (!date) {
                alert('ğŸ’¡ è¯·é€‰æ‹©è®°è´¦æ—¥æœŸï¼');
                return;
            }

            // åˆ›å»ºæ–°è®°å½•
            const newRecord = {
                id: Date.now(),
                user: user,
                type: type,
                category: category,
                amount: amount,
                date: date,
                remark: remark
            };

            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            const records = getRecords();
            records.push(newRecord);
            saveRecords(records);

            // é‡ç½®è¡¨å•
            resetForm();

            // é‡æ–°åŠ è½½æ•°æ®å’Œç»Ÿè®¡
            loadRecords();
            filterRecords();
            alert('ğŸ‰ è®°è´¦æˆåŠŸï¼');
        }

        // 7. åŠ è½½å¹¶æ¸²æŸ“è®°è´¦æ˜ç»†
        function loadRecords(filteredRecords = null) {
            const records = filteredRecords || getRecords();
            const recordsBody = document.getElementById('recordsBody');
            recordsBody.innerHTML = '';

            // å€’åºæ˜¾ç¤º
            const reversedRecords = [...records].reverse();
            reversedRecords.forEach(record => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${record.date}</td>
                    <td>${record.user}</td>
                    <td>${record.type}</td>
                    <td>${record.category}</td>
                    <td>${record.amount.toFixed(2)}</td>
                    <td>${record.remark || '-'}</td>
                    <td class="operate-btn">
                        <span class="edit-btn" onclick="editRecord(${record.id})">ä¿®æ”¹</span>
                        <span class="delete-btn" onclick="showDeleteModal(${record.id})">åˆ é™¤</span>
                    </td>
                `;
                recordsBody.appendChild(tr);
            });
        }

        // 8. ç¼–è¾‘è®°å½• - å›å¡«æ•°æ®åˆ°è¡¨å•
        function editRecord(recordId) {
            const records = getRecords();
            const record = records.find(item => item.id === recordId);
            if (!record) return;

            // å›å¡«æ•°æ®åˆ°è¡¨å•
            document.getElementById('userSelect').value = record.user;
            document.getElementById('typeSelect').value = record.type;
            // å…ˆæ›´æ–°åˆ†ç±»é€‰é¡¹ï¼Œå†é€‰å¯¹åº”åˆ†ç±»
            changeCategoryOptions();
            document.getElementById('categorySelect').value = record.category;
            document.getElementById('amountInput').value = record.amount;
            document.getElementById('dateInput').value = record.date;
            document.getElementById('remarkInput').value = record.remark || '';

            // å­˜å‚¨å½“å‰ä¿®æ”¹çš„è®°å½•ID
            document.getElementById('editRecordId').value = recordId;

            // åˆ‡æ¢æŒ‰é’®æ˜¾ç¤ºï¼šéšè—æ·»åŠ ï¼Œæ˜¾ç¤ºä¿®æ”¹
            document.getElementById('addRecordBtn').style.display = 'none';
            document.getElementById('editRecordBtn').style.display = 'inline-block';
        }

        // 9. ä¿å­˜ä¿®æ”¹åçš„è®°å½•
        function saveEditRecord() {
            const editId = parseInt(document.getElementById('editRecordId').value);
            if (!editId) return;

            // è·å–ä¿®æ”¹åçš„è¡¨å•æ•°æ®
            const user = document.getElementById('userSelect').value;
            const type = document.getElementById('typeSelect').value;
            const category = document.getElementById('categorySelect').value;
            const amount = parseFloat(document.getElementById('amountInput').value);
            const date = document.getElementById('dateInput').value;
            const remark = document.getElementById('remarkInput').value.trim();

            // è¡¨å•éªŒè¯
            if (!amount || isNaN(amount) || amount <= 0) {
                alert('ğŸ’¡ è¯·è¾“å…¥æœ‰æ•ˆçš„é‡‘é¢ï¼ˆå¤§äº0ï¼‰ï¼');
                return;
            }
            if (!date) {
                alert('ğŸ’¡ è¯·é€‰æ‹©è®°è´¦æ—¥æœŸï¼');
                return;
            }

            // æ‰¾åˆ°å¹¶æ›´æ–°è®°å½•
            let records = getRecords();
            records = records.map(item => {
                if (item.id === editId) {
                    return {
                        ...item,
                        user: user,
                        type: type,
                        category: category,
                        amount: amount,
                        date: date,
                        remark: remark
                    };
                }
                return item;
            });

            // ä¿å­˜ä¿®æ”¹
            saveRecords(records);

            // é‡ç½®è¡¨å•å’ŒæŒ‰é’®çŠ¶æ€
            resetForm();
            document.getElementById('addRecordBtn').style.display = 'inline-block';
            document.getElementById('editRecordBtn').style.display = 'none';

            // é‡æ–°åŠ è½½æ•°æ®å’Œç»Ÿè®¡
            loadRecords();
            filterRecords();
            alert('âœï¸ è®°å½•ä¿®æ”¹æˆåŠŸï¼');
        }

        // 10. æ˜¾ç¤ºåˆ é™¤ç¡®è®¤å¼¹çª—
        function showDeleteModal(recordId) {
            waitDeleteRecordId = recordId;
            document.getElementById('deleteModal').classList.add('show');
        }

        // 11. éšè—åˆ é™¤ç¡®è®¤å¼¹çª—
        function hideDeleteModal() {
            waitDeleteRecordId = null;
            document.getElementById('deleteModal').classList.remove('show');
        }

        // 12. ç¡®è®¤åˆ é™¤è®°å½•
        function confirmDeleteRecord() {
            if (!waitDeleteRecordId) return;

            let records = getRecords();
            records = records.filter(record => record.id !== waitDeleteRecordId);
            saveRecords(records);
            loadRecords();
            filterRecords();
            
            // éšè—å¼¹çª—å¹¶æç¤º
            hideDeleteModal();
            // è‡ªå®šä¹‰æç¤ºï¼ˆæ›¿ä»£alertï¼‰
            showToast('ğŸ—‘ï¸ è®°å½•å·²æˆåŠŸåˆ é™¤ï¼');
        }

        // 13. è‡ªå®šä¹‰æç¤ºToastï¼ˆä¼˜åŒ–ä½“éªŒï¼‰
        function showToast(message) {
            // åˆ›å»ºtoastå…ƒç´ 
            const toast = document.createElement('div');
            toast.style.position = 'fixed';
            toast.style.bottom = '30px';
            toast.style.left = '50%';
            toast.style.transform = 'translateX(-50%)';
            toast.style.padding = '12px 20px';
            toast.style.background = 'rgba(74, 74, 72, 0.8)';
            toast.style.color = 'white !important';
            toast.style.borderRadius = '8px';
            toast.style.fontSize = '14px';
            toast.style.zIndex = '9999';
            toast.style.opacity = '0';
            toast.style.transition = 'opacity 0.3s ease';
            toast.textContent = message;
            
            // æ·»åŠ åˆ°é¡µé¢
            document.body.appendChild(toast);
            
            // æ˜¾ç¤ºtoast
            setTimeout(() => {
                toast.style.opacity = '1';
            }, 100);
            
            // 3ç§’åç§»é™¤
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 300);
            }, 3000);
        }

        // 14. ç­›é€‰å¹¶ç»Ÿè®¡æ•°æ®
        function filterRecords() {
            const dimension = document.getElementById('viewDimension').value;
            const filterValue = currentSelectValue;
            const records = getRecords();

            // ç­›é€‰ç¬¦åˆæ¡ä»¶çš„è®°å½•
            let filteredRecords = [];
            if (dimension === 'day') {
                // æŒ‰æ—¥ç­›é€‰ï¼šç²¾ç¡®åŒ¹é…YYYY-MM-DD
                filteredRecords = records.filter(record => record.date === filterValue);
            } else if (dimension === 'month') {
                // æŒ‰æœˆç­›é€‰ï¼šåŒ¹é…YYYY-MMå¼€å¤´
                filteredRecords = records.filter(record => record.date.startsWith(filterValue));
            } else if (dimension === 'year') {
                // æŒ‰å¹´ç­›é€‰ï¼šåŒ¹é…YYYYå¼€å¤´
                filteredRecords = records.filter(record => record.date.startsWith(filterValue));
            }

            // åŸºç¡€ç»Ÿè®¡
            let husbandExpense = 0, wifeExpense = 0;
            let husbandIncome = 0, wifeIncome = 0;
            // åˆ†ç±»ç»Ÿè®¡
            const expenseCategoryTotal = {}, incomeCategoryTotal = {};
            categoryData.æ”¯å‡º.forEach(cat => expenseCategoryTotal[cat] = 0);
            categoryData.æ”¶å…¥.forEach(cat => incomeCategoryTotal[cat] = 0);

            // éå†è®¡ç®—
            filteredRecords.forEach(record => {
                const { user, type, category, amount } = record;
                if (type === 'æ”¯å‡º') {
                    if (user === 'ä¸ˆå¤«') husbandExpense += amount;
                    else wifeExpense += amount;
                    expenseCategoryTotal[category] += amount;
                } else {
                    if (user === 'ä¸ˆå¤«') husbandIncome += amount;
                    else wifeIncome += amount;
                    incomeCategoryTotal[category] += amount;
                }
            });

            // è®¡ç®—æ±‡æ€»å€¼
            const totalExpense = husbandExpense + wifeExpense;
            const totalIncome = husbandIncome + wifeIncome;
            const totalBalance = totalIncome - totalExpense;

            // æ›´æ–°ç»Ÿè®¡æ˜¾ç¤º
            document.getElementById('husbandExpense').textContent = husbandExpense.toFixed(2);
            document.getElementById('wifeExpense').textContent = wifeExpense.toFixed(2);
            document.getElementById('totalExpense').textContent = totalExpense.toFixed(2);
            document.getElementById('totalIncome').textContent = totalIncome.toFixed(2);
            document.getElementById('totalBalance').textContent = totalBalance.toFixed(2);

            // æ›´æ–°åˆ†ç±»æ˜ç»†ç»Ÿè®¡
            renderCategoryStats('expense', expenseCategoryTotal);
            renderCategoryStats('income', incomeCategoryTotal);

            // æ¸²æŸ“ç­›é€‰åçš„æ˜ç»†
            loadRecords(filteredRecords);
        }

        // 15. æ¸²æŸ“åˆ†ç±»æ˜ç»†ç»Ÿè®¡
        function renderCategoryStats(type, categoryTotal) {
            const gridId = type === 'expense' ? 'expenseCategoryGrid' : 'incomeCategoryGrid';
            const grid = document.getElementById(gridId);
            grid.innerHTML = '';

            Object.entries(categoryTotal).forEach(([category, amount]) => {
                if (amount <= 0) return;
                const item = document.createElement('div');
                item.className = 'category-item';
                item.innerHTML = `
                    <div class="name">${category}</div>
                    <div class="value ${type === 'expense' ? 'expense' : 'income'}">${amount.toFixed(2)}</div>
                `;
                grid.appendChild(item);
            });

            if (grid.children.length === 0) {
                grid.innerHTML = `<div class="category-item">æš‚æ— ${type === 'expense' ? 'æ”¯å‡º' : 'æ”¶å…¥'}æ•°æ®</div>`;
            }
        }

        // 16. é‡ç½®è¡¨å•
        function resetForm() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('userSelect').value = 'ä¸ˆå¤«';
            document.getElementById('typeSelect').value = 'æ”¯å‡º';
            changeCategoryOptions();
            document.getElementById('amountInput').value = '';
            document.getElementById('dateInput').value = today;
            document.getElementById('remarkInput').value = '';
            document.getElementById('editRecordId').value = '';
        }
    </script>
</body>
</html>
